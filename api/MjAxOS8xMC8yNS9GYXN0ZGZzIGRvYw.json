{"title":"Fastdfs doc","date":"2019-10-25T07:30:39.121Z","link":"2019/10/25/Fastdfs doc","tags":["FastDFS","docs"],"updated":"2019-10-25T07:30:39.121Z","content":"<h3 id=\"what-is-FASTDFS\">what is FASTDFS<a href=\"2019/10/25/Fastdfs doc#what-is-FASTDFS\"></a></h3><p>简单来说就是非常快的文件管理系统, 由 <code>c语言</code>编写的轻量级的分布式文件系统</p>\n<ul>\n<li>功能包括：文件存储、文件访问（文件上传、文件下载）、文件同步等，解决了大容量存储和负载均衡的问题。特别适合以文件为载体的在线服务，如相册网站、视频网站等等。</li>\n<li>为互联网量身定制，充分考虑了冗余备份、负载均衡、线性扩容等机制，并注重高可用、高性能等指标。</li>\n<li>可以帮助我们搭建一套高性能的文件服务器集群，并提供文件上传、下载等服务</li>\n</ul>\n<p>在项目中将大文件的存取交给它去操作,可以提高项目性能</p>\n<p>整个系统分为两部分,一个是<code>tracker server</code>,来接受客户端的请求,分配任务, <code>Storage server</code> 负责具体的文件的存储,管理文件</p>\n<h3 id=\"FastDFS上传和下载流程\">FastDFS上传和下载流程<a href=\"2019/10/25/Fastdfs doc#FastDFS上传和下载流程\"></a></h3><p><strong>上传文件</strong></p>\n<ol>\n<li><code>storage server</code>定时向<code>tracker</code>上传状态信息</li>\n<li>客户端向<code>stracker server</code>发送上传链接请求</li>\n<li><code>stracker</code>查询可用的<code>storage</code>并返回<code>Storage</code>的ip和端口</li>\n<li>客户端上传文件(<code>file content &amp; metadata</code>) 到<code>storage</code></li>\n<li><code>storage</code>将生成<code>file_id</code>并将数据写入磁盘,返回路径信息和文件名(<code>file_id</code>)</li>\n</ol>\n<p><strong>下载文件</strong></p>\n<ol>\n<li>‘storage’ 依然向<code>tracker</code>上传状态信息</li>\n<li>客户端向 <code>stracker server</code>发送下载链接请求</li>\n<li><code>stracker</code>返回可用的<code>storage</code>的ip和端口</li>\n<li>客户端向<code>storage</code>通过<code>file_id</code>的到文件</li>\n</ol>\n<h3 id=\"在Docker中运行Fastdfs\">在Docker中运行Fastdfs<a href=\"2019/10/25/Fastdfs doc#在Docker中运行Fastdfs\"></a></h3><p><strong>从仓库中拉取dfs镜像</strong></p>\n<pre><code>docker image pull delron/fastdfs</code></pre><p><strong>开启tracker服务</strong></p>\n<p>将<code>/var/fdfs/tracker</code>当做运行目录</p>\n<pre><code>sudo docker run -dit --name tracker --network=host -v /var/fdfs/tracker:/var/fdfs delron/fastdfs tracker</code></pre><p><strong>开启storage服务</strong></p>\n<p>local_ip是本机的内网ip,而非<code>127.0.0.1</code>,如果要镜像外网访问这里要设置内网ip</p>\n<pre><code>sudo docker run -dti --name storage --network=host -e TRACKER_SERVER=local_ip:22122 -v /var/fdfs/storage:/var/fdfs delron/fastdfs storage</code></pre><p><em>在开启和关闭storage服务的时候会遇到,关闭之后不能开启的情况, 将<code>fdfs_storaged.pid</code>删除,再重启</em></p>\n<h3 id=\"客户端连接Fastdfs\">客户端连接Fastdfs<a href=\"2019/10/25/Fastdfs doc#客户端连接Fastdfs\"></a></h3><p><em>安装<code>Fastdfs_client</code></em></p>\n<pre><code>git clone https://github.com/JaceHo/fdfs_client-py.git\ncd fdfs_client\npython setup.py install</code></pre><p><code>Fastdfs_client</code>还需要<code>mutagen</code>支持</p>\n<pre><code>pip install mutagen</code></pre><p><em>客户端配置</em></p>\n<p>在连接的时候需要加载配置,配置如下, 需要的基础配置有<code>base_path</code>(日志目录), <code>connect_timeout</code>(超时时间), <code>tracker_server</code>(服务ip和端口)</p>\n<pre><code>base_path=/home/io/Desktop\n# connect timeout in seconds\n# default value is 30s\nconnect_timeout=30\n\n# network timeout in seconds\n# default value is 30s\nnetwork_timeout=120\n\n# the base path to store log files\nbase_path=/home/io/Desktop/\n\n# tracker_server can ocur more than once, and tracker_server format is\n#  &quot;host:port&quot;, host can be hostname or ip address\ntracker_server=47.97.91.156:22122\n\n#standard log level as syslog, case insensitive, value list:\n### emerg for emergency\n### alert\n### crit for critical\n### error\n### warn for warning\n### notice\n### info\n### debug\nlog_level=info\n\n# if use connection pool\n# default value is false\n# since V4.05\nuse_connection_pool = false\n\n# connections whose the idle time exceeds this time will be closed\n# unit: second\n# default value is 3600\n# since V4.05\nconnection_pool_max_idle_time = 3600\n\n# if load FastDFS parameters from tracker server\n# since V4.05\n# default value is false\nload_fdfs_parameters_from_tracker=false\n\n# if use storage ID instead of IP address\n# same as tracker.conf\n# valid only when load_fdfs_parameters_from_tracker is false\n# default value is false\n# since V4.05\nuse_storage_id = false\n\n# specify storage ids filename, can use relative or absolute path\n# same as tracker.conf\n# valid only when load_fdfs_parameters_from_tracker is false\n# since V4.05\nstorage_ids_filename = storage_ids.conf\n\n\n#HTTP settings\nhttp.tracker_server_port=80\n\n#use &quot;#include&quot; directive to include HTTP other settiongs\n##include http.conf</code></pre><p><em>测试连接</em></p>\n<pre><code>&gt;&gt;&gt; from fdfs_client.client import *\n&gt;&gt;&gt; client = Fdfs_client(&apos;/etc/fdfs/client.conf&apos;)\n&gt;&gt;&gt; ret = client.upload_by_filename(&apos;绝对路径&apos;)</code></pre><h3 id=\"fastdfs交付nginx代理\">fastdfs交付nginx代理<a href=\"2019/10/25/Fastdfs doc#fastdfs交付nginx代理\"></a></h3><p><code>Fastdfs</code> 是擅长做存储的,跟网络打交道还是需要<code>nginx</code>, 所以需要将<code>docker</code>中的 <code>Fastdfs</code>去和<code>nginx</code>结合</p>\n<p><em>更改storage的端口</em></p>\n<p>进入已经启动的<code>storage</code>将端口修改, 默认的端口是8888,最好是不改,</p>\n<pre><code>docker exec -it storage bash\nvi /etc/fdfs/storage.conf ---&gt; http.server_port=8888</code></pre><p><em>配置nginx</em><br>在<code>nginx</code>的配置中修改 <code>http</code>中的<code>server</code></p>\n<pre><code>cd /etc/nginx\nvi nginx.config\n\nhttp{\n\n......\n\n    server{\n        listen    8874; # 8888端口是nginx的启动测试端口\n        server_name    xx.xx.xx.xx; # 内网ip或外网ip\n        location    /group1/M00{ # storage data 的存储位置\n            alias    /var/fdfs/storage/data;\n        }\n    error_page    500 502 503 504 /50x.html;\n    location =    /50x.html{\n        root html;\n        }\n    }\n\n......\n\n}</code></pre><p><em>测试是否成功</em><br>进入<code>storage</code>上传一个测试文本</p>\n<pre><code>&gt;&gt;&gt; docker exec -it storage bash     \n\n&gt;&gt;&gt; echo hello_world&gt;a.txt                 \n\n\n&gt;&gt;&gt; /usr/bin/fdfs_upload_file /etc/fdfs/client.conf a.txt  \n/group1/M00/00/02/rBDRdF2oI0qAN9jWAAAABncc3SA745.txt\n\n&gt;&gt;&gt; curl http://xx.xx.xx.xx:8874/group1/M00/00/02/rBDRdF2oI0qAN9jWAAAABncc3SA745.txt\nhello_world</code></pre>","prev":{"title":"项目开发","link":"2019/10/26/项目开发"},"next":{"title":"Hello World","link":"2019/10/24/hello-world"},"plink":"http://jccjd.top/2019/10/25/Fastdfs doc/","copyright":{"link":"<a href=\"http://jccjd.top/2019/10/25/Fastdfs doc/\" title=\"Fastdfs doc\">http://jccjd.top/2019/10/25/Fastdfs doc/</a>","license":"自由转载-非商用-禁止演绎-保持署名 (<a href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/\" rel=\"external nofollow noopener\" target=\"_blank\">CC BY-NC-ND 4.0</a>)"}}